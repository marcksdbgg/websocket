<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Controlador</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #000;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #fff;
      font-family: monospace;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="debug">0</div>
  <script>
    // WebSocket connection
    const ws = new WebSocket('wss://d0d7-2001-1388-53a0-ca20-8899-2950-83d2-b2df.ngrok-free.app');
    ws.onopen = () => console.log("WebSocket conectado");
    ws.onerror = (e) => console.error("WebSocket error:", e);

    // Variables for each half
    let valueRed = 0, valueBlue = 0;
    let isPressedRed = false, isPressedBlue = false;
    let pressStartTimeRed = 0, pressStartTimeBlue = 0;
    let fallVelocityRed = 0, fallVelocityBlue = 0;
    const GRAVITY = 0.68;
    let debugElement = document.getElementById('debug');

    // Helper to get touch/click position
    function getHalf(e) {
      let y;
      if (e.touches && e.touches.length > 0) {
        y = e.touches[0].clientY;
      } else {
        y = e.clientY;
      }
      return (y < window.innerHeight / 2) ? 'red' : 'blue';
    }

    // Permitir multitouch y mouse simultáneo
    document.addEventListener('mousedown', function(e) {
      if (getHalf(e) === 'red') startPressRed();
      if (getHalf(e) === 'blue') startPressBlue();
    });
    document.addEventListener('mouseup', function(e) {
      if (getHalf(e) === 'red') endPressRed();
      if (getHalf(e) === 'blue') endPressBlue();
    });
    document.addEventListener('touchstart', function(e) {
      for (let i = 0; i < e.touches.length; i++) {
        const y = e.touches[i].clientY;
        if (y < window.innerHeight / 2) isPressedRed = true;
        else isPressedBlue = true;
      }
      if (isPressedRed && !pressStartTimeRed) { pressStartTimeRed = Date.now(); fallVelocityRed = 0; updateValueRed(); }
      if (isPressedBlue && !pressStartTimeBlue) { pressStartTimeBlue = Date.now(); fallVelocityBlue = 0; updateValueBlue(); }
    });
    document.addEventListener('touchend', function(e) {
      // Verificar si quedan dedos en cada mitad
      let stillRed = false, stillBlue = false;
      for (let i = 0; i < e.touches.length; i++) {
        const y = e.touches[i].clientY;
        if (y < window.innerHeight / 2) stillRed = true;
        else stillBlue = true;
      }
      if (!stillRed) { isPressedRed = false; fallVelocityRed = 0; animateFallRed(); pressStartTimeRed = 0; }
      if (!stillBlue) { isPressedBlue = false; fallVelocityBlue = 0; animateFallBlue(); pressStartTimeBlue = 0; }
    });
    document.addEventListener('touchcancel', function(e) {
      isPressedRed = false; fallVelocityRed = 0; animateFallRed(); pressStartTimeRed = 0;
      isPressedBlue = false; fallVelocityBlue = 0; animateFallBlue(); pressStartTimeBlue = 0;
    });

    // --- Android Volume Button Support (limpio y compatible) ---
    // Volume Up (24) = pelota roja, Volume Down (25) = pelota azul
    document.addEventListener('keydown', function(e) {
      if (e.keyCode === 24 || e.key === 'AudioVolumeUp') {
        e.preventDefault();
        startPressRed();
        return false;
      }
      if (e.keyCode === 25 || e.key === 'AudioVolumeDown') {
        e.preventDefault();
        startPressBlue();
        return false;
      }
    });
    document.addEventListener('keyup', function(e) {
      if (e.keyCode === 24 || e.key === 'AudioVolumeUp') {
        e.preventDefault();
        endPressRed();
        return false;
      }
      if (e.keyCode === 25 || e.key === 'AudioVolumeDown') {
        e.preventDefault();
        endPressBlue();
        return false;
      }
    });
    // Prevenir el comportamiento por defecto de los botones de volumen en Android
    window.addEventListener('keydown', function(e) {
      if (e.keyCode === 24 || e.keyCode === 25 || e.key === 'AudioVolumeUp' || e.key === 'AudioVolumeDown') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);

    // Red ball logic (top half)
    function startPressRed() {
      if (!isPressedRed) {
        isPressedRed = true;
        pressStartTimeRed = Date.now();
        fallVelocityRed = 0;
        updateValueRed();
      }
    }
    function endPressRed() {
      if (isPressedRed) {
        isPressedRed = false;
        fallVelocityRed = 0;
        animateFallRed();
        pressStartTimeRed = 0;
      }
    }
    function updateValueRed() {
      if (!isPressedRed) return;
      const elapsedTime = (Date.now() - pressStartTimeRed) / 1000;
      const accelerationFactor = Math.min(elapsedTime / 5, 1);
      const increment = 0.2 * (1 + 9 * accelerationFactor);
      valueRed = Math.min(100, valueRed + increment);
      sendValue('red', valueRed);
      debugElement.textContent = `R:${Math.round(valueRed)} B:${Math.round(valueBlue)}`;
      setTimeout(updateValueRed, 16); // ~60fps
    }
    function animateFallRed() {
      if (isPressedRed) return;
      fallVelocityRed += GRAVITY * 0.05;
      valueRed = Math.max(0, valueRed - fallVelocityRed);
      sendValue('red', valueRed);
      debugElement.textContent = `R:${Math.round(valueRed)} B:${Math.round(valueBlue)}`;
      if (valueRed > 0) setTimeout(animateFallRed, 16);
    }

    // Blue ball logic (bottom half)
    function startPressBlue() {
      if (!isPressedBlue) {
        isPressedBlue = true;
        pressStartTimeBlue = Date.now();
        fallVelocityBlue = 0;
        updateValueBlue();
      }
    }
    function endPressBlue() {
      if (isPressedBlue) {
        isPressedBlue = false;
        fallVelocityBlue = 0;
        animateFallBlue();
        pressStartTimeBlue = 0;
      }
    }
    function updateValueBlue() {
      if (!isPressedBlue) return;
      const elapsedTime = (Date.now() - pressStartTimeBlue) / 1000;
      const accelerationFactor = Math.min(elapsedTime / 5, 1);
      const increment = 0.2 * (1 + 9 * accelerationFactor);
      valueBlue = Math.min(100, valueBlue + increment);
      sendValue('blue', valueBlue);
      debugElement.textContent = `R:${Math.round(valueRed)} B:${Math.round(valueBlue)}`;
      setTimeout(updateValueBlue, 16);
    }
    function animateFallBlue() {
      if (isPressedBlue) return;
      fallVelocityBlue += GRAVITY * 0.05;
      valueBlue = Math.max(0, valueBlue - fallVelocityBlue);
      sendValue('blue', valueBlue);
      debugElement.textContent = `R:${Math.round(valueRed)} B:${Math.round(valueBlue)}`;
      if (valueBlue > 0) setTimeout(animateFallBlue, 16);
    }

    // Enviar valor para la pelota correspondiente
    function sendValue(ball, value) {
      let normalizedValue = Math.round(value) / 100;
      let x = (ball === 'red') ? 0.0 : 1.0;
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ ball: ball, x: x, y: normalizedValue }));
      }
    }

    // Android volume button support
    document.addEventListener('keydown', function(e) {
      // Volume Up button (código 24) - Red ball
      if (e.keyCode === 24 || e.key === 'AudioVolumeUp') {
        e.preventDefault(); // Evitar cambio de volumen
        startPressRed();
        return false;
      }
      // Volume Down button (código 25) - Blue ball  
      if (e.keyCode === 25 || e.key === 'AudioVolumeDown') {
        e.preventDefault(); // Evitar cambio de volumen
        startPressBlue();
        return false;
      }
    });

    document.addEventListener('keyup', function(e) {
      // Volume Up button release - Red ball
      if (e.keyCode === 24 || e.key === 'AudioVolumeUp') {
        e.preventDefault();
        endPressRed();
        return false;
      }
      // Volume Down button release - Blue ball
      if (e.keyCode === 25 || e.key === 'AudioVolumeDown') {
        e.preventDefault(); 
        endPressBlue();
        return false;
      }
    });

    // Prevenir el comportamiento por defecto de los botones de volumen
    window.addEventListener('keydown', function(e) {
      if (e.keyCode === 24 || e.keyCode === 25 || 
          e.key === 'AudioVolumeUp' || e.key === 'AudioVolumeDown') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
  </script>
</body>
</html>
