<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Controlador</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #000;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #fff;
      font-family: monospace;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="debug">0</div>

  <script>
    /* ---------------------------------
       Conexión WebSocket
    -----------------------------------*/
    const ws = new WebSocket(
      'wss://488-2001-1388-53a1-a20d-7dc1-6eda-7ccc-4ad1.ngrok-free.app'
    );
    ws.addEventListener('open', () => console.log('WebSocket conectado'));
    ws.addEventListener('error', e => console.error('WebSocket error:', e));

    /* ---------------------------------
       Variables de estado
    -----------------------------------*/
    let valueRed  = 0,
        valueBlue = 0;

    let isPressedRed  = false,
        isPressedBlue = false;

    let pressStartTimeRed  = 0,
        pressStartTimeBlue = 0;

    let fallVelocityRed  = 0,
        fallVelocityBlue = 0;

    const GRAVITY     = 0.68;
    const FRAME_DELAY = 16;          // ≈60 FPS

    const debugElement = document.getElementById('debug');

    /* ---------------------------------
       Utilidades
    -----------------------------------*/
    function getHalf (e) {
      const y = (e.touches?.[0]?.clientY ?? e.clientY);
      return y < window.innerHeight / 2 ? 'red' : 'blue';
    }

    function updateDebug () {
      debugElement.textContent =
        `R:${Math.round(valueRed)} B:${Math.round(valueBlue)}`;
    }

    /* ---------------------------------
       Entrada táctil / ratón
    -----------------------------------*/
    document.addEventListener('mousedown',  e => {
      getHalf(e) === 'red' ? startPressRed() : startPressBlue();
    });

    document.addEventListener('mouseup',    e => {
      getHalf(e) === 'red' ? endPressRed()   : endPressBlue();
    });

    document.addEventListener('touchstart', e => {
      for (const t of e.touches) {
        if (t.clientY < window.innerHeight / 2) isPressedRed  = true;
        else                                   isPressedBlue = true;
      }
      if (isPressedRed  && !pressStartTimeRed)  { pressStartTimeRed  = Date.now(); fallVelocityRed  = 0; updateValueRed();  }
      if (isPressedBlue && !pressStartTimeBlue) { pressStartTimeBlue = Date.now(); fallVelocityBlue = 0; updateValueBlue(); }
    }, {passive:false});

    function handleTouchEndLikeEvent (e) {
      let stillRed = false, stillBlue = false;
      for (const t of e.touches) {
        if (t.clientY < window.innerHeight / 2) stillRed  = true;
        else                                   stillBlue = true;
      }
      if (!stillRed)  { isPressedRed  = false; fallVelocityRed  = 0; animateFallRed();  pressStartTimeRed  = 0; }
      if (!stillBlue) { isPressedBlue = false; fallVelocityBlue = 0; animateFallBlue(); pressStartTimeBlue = 0; }
    }

    document.addEventListener('touchend',    handleTouchEndLikeEvent);
    document.addEventListener('touchcancel', handleTouchEndLikeEvent);

    /* ---------------------------------
       Botones de volumen (Android)
       VolUp  -> rojo,  VolDown -> azul
    -----------------------------------*/
    const KEY_VOL_UP   = 'AudioVolumeUp';   // e.key
    const KEY_VOL_DOWN = 'AudioVolumeDown'; // e.key
    const CODE_VOL_UP  = 24;                // e.keyCode
    const CODE_VOL_DOWN= 25;

    document.addEventListener('keydown', e => {
      if (e.key === KEY_VOL_UP   || e.keyCode === CODE_VOL_UP)   { e.preventDefault(); startPressRed();  }
      if (e.key === KEY_VOL_DOWN || e.keyCode === CODE_VOL_DOWN) { e.preventDefault(); startPressBlue(); }
    });

    document.addEventListener('keyup', e => {
      if (e.key === KEY_VOL_UP   || e.keyCode === CODE_VOL_UP)   { e.preventDefault(); endPressRed();  }
      if (e.key === KEY_VOL_DOWN || e.keyCode === CODE_VOL_DOWN) { e.preventDefault(); endPressBlue(); }
    });

    // Impedimos que el sistema cambie el volumen
    window.addEventListener('keydown', e => {
      if (
        e.keyCode === CODE_VOL_UP   || e.keyCode === CODE_VOL_DOWN ||
        e.key    === KEY_VOL_UP     || e.key    === KEY_VOL_DOWN
      ) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);

    /* ---------------------------------
       Lógica pelota ROJA (superior)
    -----------------------------------*/
    function startPressRed () {
      if (!isPressedRed) {
        isPressedRed     = true;
        pressStartTimeRed= Date.now();
        fallVelocityRed  = 0;
        updateValueRed();
      }
    }
    function endPressRed () {
      if (isPressedRed) {
        isPressedRed     = false;
        fallVelocityRed  = 0;
        animateFallRed();
        pressStartTimeRed= 0;
      }
    }
    function updateValueRed () {
      if (!isPressedRed) return;
      const elapsed = (Date.now() - pressStartTimeRed) / 1000;
      const accel   = Math.min(elapsed / 5, 1);
      const inc     = 0.2 * (1 + 9 * accel);
      valueRed      = Math.min(100, valueRed + inc);
      sendValue('red', valueRed);
      updateDebug();
      setTimeout(updateValueRed, FRAME_DELAY);
    }
    function animateFallRed () {
      if (isPressedRed) return;
      fallVelocityRed += GRAVITY * 0.05;
      valueRed         = Math.max(0, valueRed - fallVelocityRed);
      sendValue('red', valueRed);
      updateDebug();
      if (valueRed > 0) setTimeout(animateFallRed, FRAME_DELAY);
    }

    /* ---------------------------------
       Lógica pelota AZUL (inferior)
    -----------------------------------*/
    function startPressBlue () {
      if (!isPressedBlue) {
        isPressedBlue     = true;
        pressStartTimeBlue= Date.now();
        fallVelocityBlue  = 0;
        updateValueBlue();
      }
    }
    function endPressBlue () {
      if (isPressedBlue) {
        isPressedBlue     = false;
        fallVelocityBlue  = 0;
        animateFallBlue();
        pressStartTimeBlue= 0;
      }
    }
    function updateValueBlue () {
      if (!isPressedBlue) return;
      const elapsed = (Date.now() - pressStartTimeBlue) / 1000;
      const accel   = Math.min(elapsed / 5, 1);
      const inc     = 0.2 * (1 + 9 * accel);
      valueBlue     = Math.min(100, valueBlue + inc);
      sendValue('blue', valueBlue);
      updateDebug();
      setTimeout(updateValueBlue, FRAME_DELAY);
    }
    function animateFallBlue () {
      if (isPressedBlue) return;
      fallVelocityBlue += GRAVITY * 0.05;
      valueBlue         = Math.max(0, valueBlue - fallVelocityBlue);
      sendValue('blue', valueBlue);
      updateDebug();
      if (valueBlue > 0) setTimeout(animateFallBlue, FRAME_DELAY);
    }

    /* ---------------------------------
       Envío de datos al servidor
    -----------------------------------*/
    function sendValue (ball, value) {
      if (ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({
        ball,
        x: ball === 'red' ? 0.0 : 1.0,
        y: Math.round(value) / 100
      }));
    }
  </script>
</body>
</html>
