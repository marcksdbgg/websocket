<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Control MindBall</title>
<style>
  :root{--bg:#000} *{margin:0;padding:0;user-select:none}
  body{width:100vw;height:100vh;background:var(--bg);touch-action:none}
  #debug{position:fixed;top:10px;left:10px;
         font:20px/1 monospace;background:#0008;color:#fff;padding:4px 8px;
         border-radius:6px}
</style>
</head>
<body>
<div id="debug">R:0 B:0</div>

<script>
/* ------------ Configuración ------------ */
const WS_URL = "ws://127.0.0.1:4649";        // cámbialo si usas ngrok
const GRAVITY      = 0.68;                   // caída por cuadro
const INC_BASE     = 0.2;                    // incremento mínimo
const INC_MAX_TIME = 5;                      // seg hasta alcanzar máx vel
/* --------------------------------------- */

let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen  = () => console.log("✅ WebSocket conectado");
  ws.onerror = e  => console.error("WebSocket error:", e);
  ws.onclose = () => { console.warn("WebSocket cerrado, reconectando…");
                       setTimeout(connectWS, 1000); };
}
connectWS();

/* ----- Estado ----- */
let red   = {val:0, pressed:false, start:0, vFall:0};
let blue  = {val:0, pressed:false, start:0, vFall:0};
const dbg = document.getElementById("debug");

/* ----- Utilidades ----- */
function send(ball, value){
  if(ws.readyState!==WebSocket.OPEN) return;
  ws.send(JSON.stringify({
      ball,
      x : ball==="red"?0:1,
      y : +(value/100).toFixed(2)
  }));
}

function updateDebug(){
  dbg.textContent=`R:${Math.round(red.val)}  B:${Math.round(blue.val)}`;
}

/* ----- Entrada táctil / ratón unificada con pointer events ----- */
function handlePointerDown(e){
  const half = (e.clientY < innerHeight/2) ? red : blue;
  if(!half.pressed){
    half.pressed=true;
    half.start=performance.now();
    half.vFall=0;
  }
}
function handlePointerUp(e){
  const half = (e.clientY < innerHeight/2) ? red : blue;
  half.pressed=false;
  half.vFall=0;
}
document.addEventListener("pointerdown",handlePointerDown);
document.addEventListener("pointerup",handlePointerUp);
document.addEventListener("pointercancel",handlePointerUp);

/* ----- Botones de volumen Android ----- */
function volKey(e,isDown){
  if(e.keyCode===24||e.key==="AudioVolumeUp"){   // ↑ rojo
    e.preventDefault(); (isDown?red:blue);       // sólo para anular sist.
    isDown?handleVol(red):handleVolUp(red);
  }
  if(e.keyCode===25||e.key==="AudioVolumeDown"){ // ↓ azul
    e.preventDefault();
    isDown?handleVol(blue):handleVolUp(blue);
  }
}
function handleVol(obj){              // presionar
  if(!obj.pressed){obj.pressed=true; obj.start=performance.now(); obj.vFall=0;}
}
function handleVolUp(obj){            // soltar
  obj.pressed=false; obj.vFall=0;
}
document.addEventListener("keydown",e=>volKey(e,true),true);
document.addEventListener("keyup",  e=>volKey(e,false),true);

/* ----- Bucle principal ----- */
function tick(now){
  [ ["red",red], ["blue",blue] ].forEach(([name,o])=>{
    if(o.pressed){
      const t = (now-o.start)/1000;
      const a = Math.min(t/INC_MAX_TIME,1);
      o.val = Math.min(100, o.val + INC_BASE*(1+9*a));
    }else if(o.val>0){
      o.vFall += GRAVITY;
      o.val    = Math.max(0, o.val - o.vFall);
    }
    send(name,o.val);
  });
  updateDebug();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);
</script>
</body>
</html>
