<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Controlador</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #000;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #fff;
      font-family: monospace;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <div id="access-denied" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#111;color:#fff;z-index:9999;align-items:center;justify-content:center;font-size:2em;text-align:center;">Acceso denegado<br>Esta página solo está disponible desde un dispositivo autorizado.</div>
  <div id="debug">0</div>

  <script>
    // --- Protección por IP pública ---
    // Reemplaza esta IP por la de tu celular
    const ALLOWED_IP = '190.232.106.137';
    fetch('https://api.ipify.org?format=json')
      .then(r => r.json())
      .then(data => {
        if (data.ip !== ALLOWED_IP) {
          document.body.style.overflow = 'hidden';
          document.getElementById('access-denied').style.display = 'flex';
          document.getElementById('debug').style.display = 'none';
        } else {
          document.getElementById('access-denied').style.display = 'none';
          document.getElementById('debug').style.display = '';
        }
      })
      .catch(() => {
        document.getElementById('access-denied').style.display = 'flex';
        document.getElementById('debug').style.display = 'none';
      });

    // --- Lógica original (sin botones de volumen) ---
    /* ---------------------------------
       Conexión WebSocket
    -----------------------------------*/
    const ws = new WebSocket(
      'wss://33a7-2001-1388-53a1-b6bd-2d8c-2a8d-baf6-e4e6.ngrok-free.app'
    );
    ws.addEventListener('open', () => console.log('WebSocket conectado'));
    ws.addEventListener('error', e => console.error('WebSocket error:', e));

    /* ---------------------------------
       Variables de estado
    -----------------------------------*/
    let valueRed  = 0,
        valueBlue = 0;

    let isPressedRed  = false,
        isPressedBlue = false;

    let pressStartTimeRed  = 0,
        pressStartTimeBlue = 0;

    let fallVelocityRed  = 0,
        fallVelocityBlue = 0;

    const GRAVITY     = 0.68;
    const FRAME_DELAY = 16;          // ≈60 FPS

    const debugElement = document.getElementById('debug');

    /* ---------------------------------
       Utilidades
    -----------------------------------*/
    function getHalf (e) {
      const y = (e.touches?.[0]?.clientY ?? e.clientY);
      return y < window.innerHeight / 2 ? 'red' : 'blue';
    }

    function updateDebug () {
      debugElement.textContent =
        `R:${Math.round(valueRed)} B:${Math.round(valueBlue)}`;
    }

    /* ---------------------------------
       Entrada táctil / ratón
    -----------------------------------*/
    document.addEventListener('mousedown',  e => {
      getHalf(e) === 'red' ? startPressRed() : startPressBlue();
    });

    document.addEventListener('mouseup',    e => {
      getHalf(e) === 'red' ? endPressRed()   : endPressBlue();
    });

    document.addEventListener('touchstart', e => {
      e.preventDefault();
      for (const t of e.touches) {
        if (t.clientY < window.innerHeight / 2) {
            startPressRed();
        } else {
            startPressBlue();
        }
      }
    }, {passive:false});

    function handleTouchEndLikeEvent (e) {
      let stillRed = false, stillBlue = false;
      for (const t of e.touches) {
        if (t.clientY < window.innerHeight / 2) stillRed  = true;
        else                                   stillBlue = true;
      }
      if (!stillRed)  endPressRed();
      if (!stillBlue) endPressBlue();
    }

    document.addEventListener('touchend',    handleTouchEndLikeEvent);
    document.addEventListener('touchcancel', handleTouchEndLikeEvent);

    /* ---------------------------------
       Lógica pelota ROJA (superior)
    -----------------------------------*/
    function startPressRed () {
      if (!isPressedRed) {
        isPressedRed     = true;
        pressStartTimeRed= Date.now();
        fallVelocityRed  = 0;
        updateValueRed();
      }
    }
    function endPressRed () {
      if (isPressedRed) {
        isPressedRed     = false;
        pressStartTimeRed= 0;
        animateFallRed();
      }
    }
    function updateValueRed () {
      if (!isPressedRed) return;
      const elapsed = (Date.now() - pressStartTimeRed) / 1000;
      const accel   = Math.min(elapsed / 5, 1);
      const inc     = 0.2 * (1 + 9 * accel);
      valueRed      = Math.min(100, valueRed + inc);
      sendValue('red', valueRed);
      updateDebug();
      setTimeout(updateValueRed, FRAME_DELAY);
    }
    function animateFallRed () {
      if (isPressedRed || valueRed <= 0) {
        if (valueRed <= 0) valueRed = 0;
        updateDebug();
        return;
      }
      fallVelocityRed += GRAVITY * 0.05;
      valueRed         = Math.max(0, valueRed - fallVelocityRed);
      sendValue('red', valueRed);
      updateDebug();
      setTimeout(animateFallRed, FRAME_DELAY);
    }

    /* ---------------------------------
       Lógica pelota AZUL (inferior)
    -----------------------------------*/
    function startPressBlue () {
      if (!isPressedBlue) {
        isPressedBlue     = true;
        pressStartTimeBlue= Date.now();
        fallVelocityBlue  = 0;
        updateValueBlue();
      }
    }
    function endPressBlue () {
      if (isPressedBlue) {
        isPressedBlue     = false;
        pressStartTimeBlue= 0;
        animateFallBlue();
      }
    }
    function updateValueBlue () {
      if (!isPressedBlue) return;
      const elapsed = (Date.now() - pressStartTimeBlue) / 1000;
      const accel   = Math.min(elapsed / 5, 1);
      const inc     = 0.2 * (1 + 9 * accel);
      valueBlue     = Math.min(100, valueBlue + inc);
      sendValue('blue', valueBlue);
      updateDebug();
      setTimeout(updateValueBlue, FRAME_DELAY);
    }
    function animateFallBlue () {
      if (isPressedBlue || valueBlue <= 0) {
        if (valueBlue <= 0) valueBlue = 0;
        updateDebug();
        return;
      }
      fallVelocityBlue += GRAVITY * 0.05;
      valueBlue         = Math.max(0, valueBlue - fallVelocityBlue);
      sendValue('blue', valueBlue);
      updateDebug();
      setTimeout(animateFallBlue, FRAME_DELAY);
    }

    /* ---------------------------------
       Envío de datos al servidor
    -----------------------------------*/
    function sendValue (ball, value) {
      if (ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({
        ball,
        x: ball === 'red' ? 0.0 : 1.0,
        y: Math.round(value) / 100
      }));
    }
  </script>
</body>
</html>
